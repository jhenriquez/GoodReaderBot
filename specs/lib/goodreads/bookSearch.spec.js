const chai                   = require('chai');
const nock                   = require('nock');
const BookSearch             = require('../../../lib/goodreads/bookSearch');
const GoodreadsBookValidator = require('../../../model/goodreadsBookValidator');


function mockNerudaSearch () {
  nock('https://www.goodreads.com:443', {"encodedQueryParams":true})
        .get('/search/index.xml')
        .query({"key": process.env.GOODREADS_API_KEY,"q":"neruda"})
        .reply(200, `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<GoodreadsResponse>\n  <Request>\n    <authentication>true</authentication>\n      <key><![CDATA[${process.env.GOODREADS_API_KEY}]]></key>\n    <method><![CDATA[search_index]]></method>\n  </Request>\n  <search>\n  <query><![CDATA[neruda]]></query>\n    <results-start>1</results-start>\n    <results-end>20</results-end>\n    <total-results>664</total-results>\n    <source>Goodreads</source>\n    <query-time-seconds>0.15</query-time-seconds>\n    <results>\n        <work>\n  <id type=\"integer\">1739475</id>\n  <books_count type=\"integer\">8</books_count>\n  <ratings_count type=\"integer\">14364</ratings_count>\n  <text_reviews_count type=\"integer\">233</text_reviews_count>\n  <original_publication_year type=\"integer\">1974</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.44</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5936</id>\n    <title>The Poetry of Pablo Neruda</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1417605511m/5936.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1417605511s/5936.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">2103337</id>\n  <books_count type=\"integer\">173</books_count>\n  <ratings_count type=\"integer\">36430</ratings_count>\n  <text_reviews_count type=\"integer\">1408</text_reviews_count>\n  <original_publication_year type=\"integer\">1924</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.33</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5932</id>\n    <title>Twenty Love Poems and a Song of Despair</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1447622711m/5932.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1447622711s/5932.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">9293</id>\n  <books_count type=\"integer\">5</books_count>\n  <ratings_count type=\"integer\">4428</ratings_count>\n  <text_reviews_count type=\"integer\">171</text_reviews_count>\n  <original_publication_year type=\"integer\">1979</original_publication_year>\n  <original_publication_month type=\"integer\">1</original_publication_month>\n  <original_publication_day type=\"integer\">1</original_publication_day>\n  <average_rating>4.46</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5931</id>\n    <title>The Essential Neruda: Selected Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">9295</id>\n  <books_count type=\"integer\">67</books_count>\n  <ratings_count type=\"integer\">12106</ratings_count>\n  <text_reviews_count type=\"integer\">455</text_reviews_count>\n  <original_publication_year type=\"integer\">1959</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.40</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">11339</id>\n    <title>100 Love Sonnets</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">46785946</id>\n  <books_count type=\"integer\">3</books_count>\n  <ratings_count type=\"integer\">72</ratings_count>\n  <text_reviews_count type=\"integer\">20</text_reviews_count>\n  <original_publication_year type=\"integer\">2016</original_publication_year>\n  <original_publication_month type=\"integer\">5</original_publication_month>\n  <original_publication_day type=\"integer\">16</original_publication_day>\n  <average_rating>4.01</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">26760498</id>\n    <title>Breakfast With Neruda</title>\n    <author>\n      <id type=\"integer\">14851042</id>\n      <name>Laura  Moe</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1459115671m/26760498.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1459115671s/26760498.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">1509926</id>\n  <books_count type=\"integer\">52</books_count>\n  <ratings_count type=\"integer\">6140</ratings_count>\n  <text_reviews_count type=\"integer\">290</text_reviews_count>\n  <original_publication_year type=\"integer\">1952</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.26</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">11320</id>\n    <title>The Captain's Verses</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">5715425</id>\n  <books_count type=\"integer\">24</books_count>\n  <ratings_count type=\"integer\">631</ratings_count>\n  <text_reviews_count type=\"integer\">133</text_reviews_count>\n  <original_publication_year type=\"integer\">2008</original_publication_year>\n  <original_publication_month type=\"integer\">8</original_publication_month>\n  <original_publication_day type=\"integer\">1</original_publication_day>\n  <average_rating>3.59</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5544371</id>\n    <title>El caso Neruda</title>\n    <author>\n      <id type=\"integer\">38312</id>\n      <name>Roberto Ampuero</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">46170939</id>\n  <books_count type=\"integer\">2</books_count>\n  <ratings_count type=\"integer\">221</ratings_count>\n  <text_reviews_count type=\"integer\">41</text_reviews_count>\n  <original_publication_year type=\"integer\">2016</original_publication_year>\n  <original_publication_month type=\"integer\">4</original_publication_month>\n  <original_publication_day type=\"integer\">12</original_publication_day>\n  <average_rating>4.22</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">26196204</id>\n    <title>Then Come Back: The Lost Neruda Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1469453809m/26196204.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1469453809s/26196204.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">43432</id>\n  <books_count type=\"integer\">2</books_count>\n  <ratings_count type=\"integer\">408</ratings_count>\n  <text_reviews_count type=\"integer\">20</text_reviews_count>\n  <original_publication_year type=\"integer\">2004</original_publication_year>\n  <original_publication_month type=\"integer\">7</original_publication_month>\n  <original_publication_day type=\"integer\">17</original_publication_day>\n  <average_rating>4.51</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">44059</id>\n    <title>Pablo Neruda: Absence and Presence</title>\n    <author>\n      <id type=\"integer\">24764</id>\n      <name>Luis Poirot</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">339107</id>\n  <books_count type=\"integer\">84</books_count>\n  <ratings_count type=\"integer\">2259</ratings_count>\n  <text_reviews_count type=\"integer\">175</text_reviews_count>\n  <original_publication_year type=\"integer\">1974</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.20</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5938</id>\n    <title>Memoirs</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">965315</id>\n  <books_count type=\"integer\">39</books_count>\n  <ratings_count type=\"integer\">2949</ratings_count>\n  <text_reviews_count type=\"integer\">203</text_reviews_count>\n  <original_publication_year type=\"integer\">1952</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.36</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">980426</id>\n    <title>Love Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">2906799</id>\n  <books_count type=\"integer\">30</books_count>\n  <ratings_count type=\"integer\">3076</ratings_count>\n  <text_reviews_count type=\"integer\">92</text_reviews_count>\n  <original_publication_year type=\"integer\">1933</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.40</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">214888</id>\n    <title>Residence on Earth</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">14992513</id>\n  <books_count type=\"integer\">18</books_count>\n  <ratings_count type=\"integer\">2863</ratings_count>\n  <text_reviews_count type=\"integer\">110</text_reviews_count>\n  <original_publication_year type=\"integer\">1961</original_publication_year>\n  <original_publication_month type=\"integer\">6</original_publication_month>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.39</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">1547992</id>\n    <title>Selected Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">279794</id>\n  <books_count type=\"integer\">32</books_count>\n  <ratings_count type=\"integer\">2406</ratings_count>\n  <text_reviews_count type=\"integer\">329</text_reviews_count>\n  <original_publication_year type=\"integer\">1974</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.11</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">23183</id>\n    <title>The Book of Questions</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">3349450</id>\n  <books_count type=\"integer\">774</books_count>\n  <ratings_count type=\"integer\">1619227</ratings_count>\n  <text_reviews_count type=\"integer\">14149</text_reviews_count>\n  <original_publication_year type=\"integer\">1595</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>3.73</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">9487928</id>\n    <title>Romeo y Julieta</title>\n    <author>\n      <id type=\"integer\">947</id>\n      <name>William Shakespeare</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1302456079m/9487928.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1302456079s/9487928.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">14262930</id>\n  <books_count type=\"integer\">2</books_count>\n  <ratings_count type=\"integer\">418</ratings_count>\n  <text_reviews_count type=\"integer\">92</text_reviews_count>\n  <original_publication_year type=\"integer\">2011</original_publication_year>\n  <original_publication_month type=\"integer\">3</original_publication_month>\n  <original_publication_day type=\"integer\">29</original_publication_day>\n  <average_rating>4.13</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">9379297</id>\n    <title>Pablo Neruda: Poet of the People</title>\n    <author>\n      <id type=\"integer\">140616</id>\n      <name>Monica Brown</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1312061014m/9379297.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1312061014s/9379297.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">43426</id>\n  <books_count type=\"integer\">19</books_count>\n  <ratings_count type=\"integer\">1790</ratings_count>\n  <text_reviews_count type=\"integer\">88</text_reviews_count>\n  <original_publication_year type=\"integer\">1954</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.39</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">44053</id>\n    <title>Odes to Common Things</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">156701</id>\n  <books_count type=\"integer\">8</books_count>\n  <ratings_count type=\"integer\">277</ratings_count>\n  <text_reviews_count type=\"integer\">13</text_reviews_count>\n  <original_publication_year type=\"integer\">1970</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>4.27</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">162351</id>\n    <title>Neruda and Vallejo: Selected Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">507600</id>\n  <books_count type=\"integer\">12</books_count>\n  <ratings_count type=\"integer\">225</ratings_count>\n  <text_reviews_count type=\"integer\">35</text_reviews_count>\n  <original_publication_year type=\"integer\">1996</original_publication_year>\n  <original_publication_month type=\"integer\" nil=\"true\"/>\n  <original_publication_day type=\"integer\" nil=\"true\"/>\n  <average_rating>3.76</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">237604</id>\n    <title>Dr. Neruda's Cure for Evil</title>\n    <author>\n      <id type=\"integer\">139033</id>\n      <name>Rafael Yglesias</name>\n    </author>\n    <image_url>https://images.gr-assets.com/books/1344264797m/237604.jpg</image_url>\n    <small_image_url>https://images.gr-assets.com/books/1344264797s/237604.jpg</small_image_url>\n  </best_book>\n</work>\n\n        <work>\n  <id type=\"integer\">9299</id>\n  <books_count type=\"integer\">3</books_count>\n  <ratings_count type=\"integer\">1319</ratings_count>\n  <text_reviews_count type=\"integer\">75</text_reviews_count>\n  <original_publication_year type=\"integer\">1995</original_publication_year>\n  <original_publication_month type=\"integer\">5</original_publication_month>\n  <original_publication_day type=\"integer\">19</original_publication_day>\n  <average_rating>4.48</average_rating>\n  <best_book type=\"Book\">\n    <id type=\"integer\">5937</id>\n    <title>Love: Ten Poems</title>\n    <author>\n      <id type=\"integer\">4026</id>\n      <name>Pablo Neruda</name>\n    </author>\n    <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>\n    <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url>\n  </best_book>\n</work>\n\n    </results>\n</search>\n\n</GoodreadsResponse>`);
}

describe('Goodreads/BookSearch', () => {
  describe('#()', () => {
    it('Expects a Goodreads API key string. Throws Error when not provided.', () => {
      chai.expect(() => { return new BookSearch(); }).to.throw(Error, /key/i);
    });
  });

  describe('execute', () => {
    it('Resolves to an empty array of books when no query string is provided.', () => {
      nock('https://www.goodreads.com:443', {"encodedQueryParams":true})
        .get('/search/index.xml')
        .query({"key": process.env.GOODREADS_API_KEY })
        .reply(200, `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<GoodreadsResponse>\n  <Request>\n    <authentication>true</authentication>\n      <key><![CDATA[${process.env.GOODREADS_API_KEY}]]></key>\n    <method><![CDATA[search_index]]></method>\n  </Request>\n  <search>\n  <query><![CDATA[]]></query>\n    <results-start>1</results-start>\n    <results-end>0</results-end>\n    <total-results>0</total-results>\n    <source>Goodreads</source>\n    <query-time-seconds></query-time-seconds>\n    <results>\n    </results>\n</search>\n\n</GoodreadsResponse>`);

      return new BookSearch(process.env.GOODREADS_API_KEY).execute().then((books) => books.should.have.length(0));
    });

    it('Resolves to at least 20 items for a popular author like neruda', () => {
      mockNerudaSearch();
      return new BookSearch(process.env.GOODREADS_API_KEY).execute('neruda').then(books => books.should.have.length(20));
    });

    it('Book objects conform to the following structure: { id, title, author: { name }, image_url, small_image_url }', () => {
      mockNerudaSearch();
      return new BookSearch(process.env.GOODREADS_API_KEY).execute('neruda').then(books => {
        books.forEach((b) => chai.expect(GoodreadsBookValidator.validate(b).error).to.be.null);
      });
    });
  });
});